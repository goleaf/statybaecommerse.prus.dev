<?php

declare(strict_types=1);

namespace Tests\Feature\Filament;

use App\Models\Country;
use App\Models\User;
use Illuminate\Foundation\Testing\RefreshDatabase;
use Livewire\Livewire;
use Tests\TestCase;

final class CountryResourceTest extends TestCase
{
    use RefreshDatabase;

    protected function setUp(): void
    {
        parent::setUp();

        $user = User::factory()->create();
        $this->actingAs($user);
    }

    public function test_country_resource_can_render_list_page(): void
    {
        Country::factory()->count(5)->create();

        $this
            ->get(route('filament.admin.resources.countries.index'))
            ->assertOk();
    }

    public function test_country_resource_can_render_create_page(): void
    {
        $this
            ->get(route('filament.admin.resources.countries.create'))
            ->assertOk();
    }

    public function test_country_resource_can_create_country(): void
    {
        $countryData = [
            'name' => 'Test Country',
            'code' => 'TC',
            'iso_code' => 'TCT',
            'region' => 'europe',
            'currency_code' => 'EUR',
            'currency_symbol' => 'â‚¬',
            'phone_code' => '+1',
            'description' => 'Test country description',
            'is_active' => true,
            'is_default' => false,
            'sort_order' => 1,
        ];

        Livewire::test(\App\Filament\Resources\CountryResource\Pages\CreateCountry::class)
            ->fillForm($countryData)
            ->call('create')
            ->assertHasNoFormErrors();

        $this->assertDatabaseHas('countries', [
            'name' => 'Test Country',
            'code' => 'TC',
            'iso_code' => 'TCT',
        ]);
    }

    public function test_country_resource_can_render_edit_page(): void
    {
        $country = Country::factory()->create();

        $this
            ->get(route('filament.admin.resources.countries.edit', $country))
            ->assertOk();
    }

    public function test_country_resource_can_edit_country(): void
    {
        $country = Country::factory()->create([
            'name' => 'Original Name',
            'code' => 'ON',
        ]);

        $updatedData = [
            'name' => 'Updated Name',
            'code' => 'UN',
        ];

        Livewire::test(\App\Filament\Resources\CountryResource\Pages\EditCountry::class, [
            'record' => $country->getRouteKey(),
        ])
            ->fillForm($updatedData)
            ->call('save')
            ->assertHasNoFormErrors();

        $this->assertDatabaseHas('countries', [
            'id' => $country->id,
            'name' => 'Updated Name',
            'code' => 'UN',
        ]);
    }

    public function test_country_resource_can_render_view_page(): void
    {
        $country = Country::factory()->create();

        $this
            ->get(route('filament.admin.resources.countries.view', $country))
            ->assertOk();
    }

    public function test_country_resource_can_delete_country(): void
    {
        $country = Country::factory()->create();

        Livewire::test(\App\Filament\Resources\CountryResource\Pages\ListCountries::class)
            ->callTableAction('delete', $country);

        $this->assertSoftDeleted('countries', [
            'id' => $country->id,
        ]);
    }

    public function test_country_resource_table_filters_work(): void
    {
        Country::factory()->create(['is_active' => true, 'is_eu_member' => true]);
        Country::factory()->create(['is_active' => false, 'is_eu_member' => false]);

        // Test active filter
        Livewire::test(\App\Filament\Resources\CountryResource\Pages\ListCountries::class)
            ->filterTable('is_active', '1')
            ->assertCanSeeTableRecords(Country::where('is_active', true)->get());

        // Test EU member filter
        Livewire::test(\App\Filament\Resources\CountryResource\Pages\ListCountries::class)
            ->filterTable('is_eu_member', '1')
            ->assertCanSeeTableRecords(Country::where('is_eu_member', true)->get());
    }

    public function test_country_resource_table_search_works(): void
    {
        Country::factory()->create(['name' => 'Lithuania']);
        Country::factory()->create(['name' => 'Germany']);

        Livewire::test(\App\Filament\Resources\CountryResource\Pages\ListCountries::class)
            ->searchTable('Lithuania')
            ->assertCanSeeTableRecords(Country::where('name', 'Lithuania')->get())
            ->assertCanNotSeeTableRecords(Country::where('name', 'Germany')->get());
    }

    public function test_country_resource_bulk_actions_work(): void
    {
        $countries = Country::factory()->count(3)->create(['is_active' => false]);

        Livewire::test(\App\Filament\Resources\CountryResource\Pages\ListCountries::class)
            ->callTableBulkAction('activate', $countries)
            ->assertHasNoTableBulkActionErrors();

        foreach ($countries as $country) {
            $this->assertDatabaseHas('countries', [
                'id' => $country->id,
                'is_active' => true,
            ]);
        }
    }

    public function test_country_resource_widgets_load(): void
    {
        Country::factory()->count(10)->create();

        $this
            ->get(route('filament.admin.resources.countries.index'))
            ->assertOk()
            ->assertSee('Total Countries')
            ->assertSee('Active Countries');
    }

    public function test_country_resource_validation_works(): void
    {
        // Test required fields
        Livewire::test(\App\Filament\Resources\CountryResource\Pages\CreateCountry::class)
            ->fillForm([])
            ->call('create')
            ->assertHasFormErrors(['name']);

        // Test unique constraints
        Country::factory()->create(['code' => 'LT']);

        Livewire::test(\App\Filament\Resources\CountryResource\Pages\CreateCountry::class)
            ->fillForm([
                'name' => 'Lithuania',
                'code' => 'LT',  // Already exists
            ])
            ->call('create')
            ->assertHasFormErrors(['code']);
    }

    public function test_country_resource_translation_management(): void
    {
        $country = Country::factory()->create([
            'name' => 'France',
            'description' => 'A country in Europe',
        ]);

        // Test updating country with translation data
        Livewire::test(\App\Filament\Resources\CountryResource\Pages\EditCountry::class, [
            'record' => $country->getRouteKey(),
        ])
            ->fillForm([
                'name' => 'France',
                'description' => 'Un pays en Europe',
                'region' => 'europe',
                'currency_code' => 'EUR',
                'currency_symbol' => 'â‚¬',
            ])
            ->call('save')
            ->assertHasNoFormErrors();

        $this->assertDatabaseHas('countries', [
            'id' => $country->id,
            'name' => 'France',
            'description' => 'Un pays en Europe',
        ]);
    }

    public function test_country_resource_global_search(): void
    {
        Country::factory()->create(['name' => 'Spain', 'code' => 'ES']);
        Country::factory()->create(['name' => 'Portugal', 'code' => 'PT']);

        // Test global search functionality
        $this
            ->get(route('filament.admin.resources.countries.index').'?search=Spain')
            ->assertOk()
            ->assertSee('Spain')
            ->assertDontSee('Portugal');
    }

    public function test_country_resource_toggle_active_action(): void
    {
        $country = Country::factory()->create(['is_active' => false]);

        Livewire::test(\App\Filament\Resources\CountryResource\Pages\ListCountries::class)
            ->callTableAction('toggle_active', $country)
            ->assertHasNoTableActionErrors();

        $this->assertDatabaseHas('countries', [
            'id' => $country->id,
            'is_active' => true,
        ]);
    }

    public function test_country_resource_set_default_action(): void
    {
        $existingDefault = Country::factory()->create(['is_default' => true]);
        $newDefault = Country::factory()->create(['is_default' => false]);

        Livewire::test(\App\Filament\Resources\CountryResource\Pages\ListCountries::class)
            ->callTableAction('set_default', $newDefault)
            ->assertHasNoTableActionErrors();

        $this->assertDatabaseHas('countries', [
            'id' => $existingDefault->id,
            'is_default' => false,
        ]);

        $this->assertDatabaseHas('countries', [
            'id' => $newDefault->id,
            'is_default' => true,
        ]);
    }

    public function test_country_resource_bulk_activate_action(): void
    {
        $countries = Country::factory()->count(3)->create(['is_active' => false]);

        Livewire::test(\App\Filament\Resources\CountryResource\Pages\ListCountries::class)
            ->callTableBulkAction('activate', $countries)
            ->assertHasNoTableBulkActionErrors();

        foreach ($countries as $country) {
            $this->assertDatabaseHas('countries', [
                'id' => $country->id,
                'is_active' => true,
            ]);
        }
    }

    public function test_country_resource_bulk_deactivate_action(): void
    {
        $countries = Country::factory()->count(3)->create(['is_active' => true]);

        Livewire::test(\App\Filament\Resources\CountryResource\Pages\ListCountries::class)
            ->callTableBulkAction('deactivate', $countries)
            ->assertHasNoTableBulkActionErrors();

        foreach ($countries as $country) {
            $this->assertDatabaseHas('countries', [
                'id' => $country->id,
                'is_active' => false,
            ]);
        }
    }

    public function test_country_resource_table_filters_work(): void
    {
        Country::factory()->create(['is_active' => true, 'is_default' => true]);
        Country::factory()->create(['is_active' => false, 'is_default' => false]);

        // Test active filter
        Livewire::test(\App\Filament\Resources\CountryResource\Pages\ListCountries::class)
            ->filterTable('is_active', '1')
            ->assertCanSeeTableRecords(Country::where('is_active', true)->get());

        // Test default filter
        Livewire::test(\App\Filament\Resources\CountryResource\Pages\ListCountries::class)
            ->filterTable('is_default', '1')
            ->assertCanSeeTableRecords(Country::where('is_default', true)->get());
    }

    public function test_country_resource_table_search_works(): void
    {
        Country::factory()->create(['name' => 'Lithuania']);
        Country::factory()->create(['name' => 'Germany']);

        Livewire::test(\App\Filament\Resources\CountryResource\Pages\ListCountries::class)
            ->searchTable('Lithuania')
            ->assertCanSeeTableRecords(Country::where('name', 'Lithuania')->get())
            ->assertCanNotSeeTableRecords(Country::where('name', 'Germany')->get());
    }
}
